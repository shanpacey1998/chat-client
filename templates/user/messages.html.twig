{% extends 'base.html.twig' %}

{% block body %}
    {{ parent() }}

    <div class="container card">
        <div class="card-header">
            <div>
                <div class="container">
                    <h3 class="text-center">Chat with {{ selectedUsername }}</h3>
                </div>
            </div>
        </div>
        <div id="message_box" class="card-body card card1" style="height: 400px">
            {% for userMessage in messages %}
                {% if userMessage ends with selectedUsername %}
                    <div class="d-flex justify-content-start mb-4">
                        <div class="chat-bubble chat-bubble--left">
                            {% if userMessage starts with "https://" %}
                                <a id="attachmentFile" target="_blank" href="{{ userMessage }}" download="{{ userMessage }}">
                                    {{ userMessage }}
                                </a>
                             {% else %}
                                {{ userMessage }}
                             {% endif %}
                            <span class="text-muted msg_time">{{ "now"|date("H:m")}}</span>
                        </div>
                    </div>
                {% else %}
                    <div class="d-flex justify-content-end mb-4">
                        <div class="chat-bubble chat-bubble--right">
                            {% if userMessage starts with "https://" %}
                                <a id="attachmentFile" target="_blank" href="{{ userMessage }}" download="{{ userMessage }}">
                                    {{ userMessage }}
                                </a>
                             {% else %}
                                {{ userMessage }}
                            {% endif %}
                            <span class="text-muted msg_time">{{ "now"|date("H:m")}}</span>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <div class="card-footer">

            {{ form_start(userForm, {'method': 'POST', 'action': path('message_user', {'user': selectedUsername})}) }}
                {{ form_row(userForm.messageInput, {'attr': {'placeholder': 'Enter message here...'}}) }}
                {{ form_row(userForm.attachment) }}<button class="btn btn-primary" type="submit" name="message">Send</button>
            {{ form_end(userForm) }}

        </div>
    </div>

    <br><div class="container">
        <h4 class="text-center">Files</h4>

        <div class="container">
            {% for file in files %}
                <div class="profile-box1 col-md-6 container-fluid border">
                    {{ file.name}}

                </div>
            {% endfor %}
        </div>

    </div>

{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script>
         $(document).ready(function() {


             // clears cache and reloads page every 5 secs
            // if ( window.history.replaceState ) {
            //     window.history.replaceState( null, null, window.location.href );
            // }
            //  setInterval(function() {
            //      cache_clear()
            //  }, 10000);
            //
            // function cache_clear() {
            //     window.location.reload(true);
            //     // window.location.reload(); use this if you do not remove cache
            //     }

             document.getElementById('user_form_attachment').style.opacity = '100'; //makes profile file upload elements visible

             //automatically scrolls to show most recent message in chat on refresh
             let objDiv = document.getElementById("message_box");
             objDiv.scrollTop = objDiv.scrollHeight;

         });
    </script>
    <script>
        $("#attachmentFile").on('click')(function(){ document.getElementById('attachmentFile').href.download();   });
        // function download() {
        //     document.getElementById('attachmentFile').href.download();
        // }
    </script>
{% endblock %}
